<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Distribución - Datos Reales</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary: #4f46e5;
            --color-primary-light: #6366f1;
            --color-primary-dark: #3730a3;
            --color-secondary: #8b5cf6;
            --color-success: #10b981;
            --color-warning: #f59e0b;
            --color-danger: #ef4444;
            --color-info: #06b6d4;
            --color-light: #f8fafc;
            --color-dark: #1e293b;
            --color-gray-50: #f8fafc;
            --color-gray-100: #f1f5f9;
            --color-gray-200: #e2e8f0;
            --color-gray-300: #cbd5e1;
            --color-gray-400: #94a3b8;
            --color-gray-500: #64748b;
            --color-gray-600: #475569;
            --color-gray-700: #334155;
            --color-gray-800: #1e293b;
            --color-gray-900: #0f172a;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            --radius: 8px;
            --radius-lg: 12px;
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            color: var(--color-gray-800);
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1440px;
            margin: 0 auto;
            padding: 0 var(--spacing-lg);
        }
        
        .header {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%);
            color: white;
            padding: var(--spacing-xl) 0;
            margin-bottom: var(--spacing-xl);
            box-shadow: var(--shadow-lg);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--spacing-md);
        }
        
        .title {
            font-size: 2.25rem;
            font-weight: 700;
            margin: 0;
            background: linear-gradient(135deg, #ffffff 0%, #e2e8f0 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .subtitle {
            font-size: 1rem;
            opacity: 0.9;
            margin-top: var(--spacing-xs);
        }
        
        .header-controls {
            display: flex;
            gap: var(--spacing-sm);
            align-items: center;
            flex-wrap: wrap;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            padding: 10px 20px;
            border: none;
            border-radius: var(--radius);
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            white-space: nowrap;
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-primary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .btn-primary:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .btn-success {
            background: var(--color-success);
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .btn-light {
            background: white;
            color: var(--color-gray-700);
            border: 1px solid var(--color-gray-200);
        }
        
        .btn-light:hover {
            background: var(--color-gray-50);
        }
        
        .last-update {
            font-size: 0.875rem;
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }
        
        /* Filtros */
        .filters-section {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
            box-shadow: var(--shadow);
            border: 1px solid var(--color-gray-200);
        }
        
        .filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
        }
        
        .filters-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--color-gray-800);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }
        
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
            align-items: end;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }
        
        .form-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--color-gray-700);
        }
        
        .form-control {
            padding: 10px 12px;
            border: 1px solid var(--color-gray-300);
            border-radius: var(--radius);
            font-size: 0.875rem;
            background: white;
            transition: all 0.2s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        /* Métricas */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }
        
        .metric-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow);
            border: 1px solid var(--color-gray-200);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient);
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .metric-card.primary::before {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-light) 100%);
        }
        
        .metric-card.success::before {
            background: linear-gradient(135deg, var(--color-success) 0%, #34d399 100%);
        }
        
        .metric-card.info::before {
            background: linear-gradient(135deg, var(--color-info) 0%, #38bdf8 100%);
        }
        
        .metric-card.danger::before {
            background: linear-gradient(135deg, var(--color-danger) 0%, #f87171 100%);
        }
        
        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-md);
        }
        
        .metric-title {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--color-gray-600);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .metric-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }
        
        .metric-icon.primary {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-light) 100%);
        }
        
        .metric-icon.success {
            background: linear-gradient(135deg, var(--color-success) 0%, #34d399 100%);
        }
        
        .metric-icon.info {
            background: linear-gradient(135deg, var(--color-info) 0%, #38bdf8 100%);
        }
        
        .metric-icon.danger {
            background: linear-gradient(135deg, var(--color-danger) 0%, #f87171 100%);
        }
        
        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--color-gray-900);
            margin-bottom: var(--spacing-xs);
            line-height: 1;
        }
        
        .metric-change {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .metric-change.positive {
            color: var(--color-success);
        }
        
        .metric-change.negative {
            color: var(--color-danger);
        }
        
        .metric-change.neutral {
            color: var(--color-gray-500);
        }
        
        .metric-subtitle {
            font-size: 0.75rem;
            color: var(--color-gray-500);
            margin-top: var(--spacing-xs);
        }
        
        /* Tabla */
        .table-card {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            border: 1px solid var(--color-gray-200);
            overflow: hidden;
        }
        
        .table-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--color-gray-200);
            background: var(--color-gray-50);
        }
        
        .table-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--color-gray-800);
            margin: 0;
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        #distribution-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }
        
        #distribution-table th {
            background: var(--color-gray-50);
            padding: 16px 12px;
            font-weight: 600;
            color: var(--color-gray-700);
            text-align: left;
            border-bottom: 2px solid var(--color-gray-200);
            white-space: nowrap;
        }
        
        #distribution-table td {
            padding: 16px 12px;
            border-bottom: 1px solid var(--color-gray-200);
            vertical-align: middle;
        }
        
        #distribution-table tbody tr {
            transition: all 0.2s;
        }
        
        #distribution-table tbody tr:hover {
            background-color: var(--color-gray-50);
        }
        
        .dt-control {
            cursor: pointer;
            color: var(--color-primary);
            font-size: 1.2rem;
        }
        
        .dt-control:hover {
            color: var(--color-primary-dark);
        }
        
        /* Detalles de fila */
        .detail-content {
            padding: var(--spacing-xl);
            background: var(--color-gray-50);
        }
        
        .detail-section {
            margin-bottom: var(--spacing-xl);
        }
        
        .detail-section:last-child {
            margin-bottom: 0;
        }
        
        .detail-section h5 {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--color-gray-800);
            margin: 0 0 var(--spacing-md) 0;
            padding-bottom: var(--spacing-xs);
            border-bottom: 2px solid var(--color-primary);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }
        
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: var(--spacing-md);
        }
        
        .detail-item {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }
        
        .detail-label {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--color-gray-600);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .detail-value {
            font-size: 0.875rem;
            color: var(--color-gray-800);
            font-weight: 500;
        }
        
        .sub-table {
            width: 100%;
            background: white;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--color-gray-200);
            margin-bottom: var(--spacing-md);
        }
        
        .sub-table th {
            background: var(--color-gray-100);
            padding: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--color-gray-700);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .sub-table td {
            padding: 12px;
            font-size: 0.875rem;
            border-top: 1px solid var(--color-gray-200);
        }
        
        .client-section {
            background: white;
            border-radius: var(--radius);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            border: 1px solid var(--color-gray-200);
        }
        
        .client-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-xs);
            border-bottom: 1px solid var(--color-gray-200);
        }
        
        .client-name {
            font-size: 1rem;
            font-weight: 600;
            color: var(--color-gray-800);
        }
        
        .client-badges {
            display: flex;
            gap: var(--spacing-xs);
        }
        
        /* Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            line-height: 1;
        }
        
        .badge-primary {
            background: rgba(79, 70, 229, 0.1);
            color: var(--color-primary);
        }
        
        .badge-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--color-success);
        }
        
        .badge-warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--color-warning);
        }
        
        .badge-danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--color-danger);
        }
        
        .badge-info {
            background: rgba(6, 182, 212, 0.1);
            color: var(--color-info);
        }
        
        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .loading-content {
            text-align: center;
            padding: var(--spacing-xl);
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--color-gray-200);
            border-top: 3px solid var(--color-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto var(--spacing-md) auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: var(--color-gray-600);
            font-weight: 500;
        }
        
        /* Responsivo */
        @media (max-width: 768px) {
            .container {
                padding: 0 var(--spacing-md);
            }
            
            .header-content {
                flex-direction: column;
                align-items: stretch;
                text-align: center;
            }
            
            .title {
                font-size: 1.875rem;
            }
            
            .filters-grid {
                grid-template-columns: 1fr;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .metric-value {
                font-size: 2rem;
            }
            
            .detail-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Animaciones suaves */
        * {
            transition: color 0.2s ease, background-color 0.2s ease, border-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <div class="header-content">
                <div>
                    <h1 class="title">Dashboard de Distribución 2</h1>
                    <p class="subtitle">Sistema de gestión y seguimiento de productos</p>
                </div>
                <div class="header-controls">
                    <div class="last-update">
                        <i class="bi bi-clock"></i>
                        Última actualización: <span id="last-update"></span>
                    </div>
                    <button id="refresh-btn" class="btn btn-primary">
                        <i class="bi bi-arrow-repeat"></i> Actualizar
                    </button>
                    <button id="export-excel" class="btn btn-success">
                        <i class="bi bi-file-excel"></i> Exportar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Filtros -->
        <div class="filters-section">
            <div class="filters-header">
                <h3 class="filters-title">
                    <i class="bi bi-funnel"></i>
                    Filtros
                </h3>
                <button id="clear-filters" class="btn btn-light">
                    <i class="bi bi-x-circle"></i> Limpiar filtros
                </button>
            </div>
            <div class="filters-grid">
                <div class="form-group">
                    <label class="form-label">Fecha desde</label>
                    <input type="date" id="date-from" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">Fecha hasta</label>
                    <input type="date" id="date-to" class="form-control">
                </div>
                <div class="form-group">
                    <label class="form-label">Planta</label>
                    <select id="filter-plant" class="form-control">
                        <option value="">Todas las plantas</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Tipo</label>
                    <select id="filter-type" class="form-control">
                        <option value="">Todos los tipos</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Proveedor</label>
                    <select id="filter-provider" class="form-control">
                        <option value="">Todos los proveedores</option>
                    </select>
                </div>
                <div class="form-group">
                    <button id="apply-filters" class="btn btn-primary" style="margin-top: 24px;">
                        <i class="bi bi-search"></i> Aplicar filtros
                    </button>
                </div>
            </div>
        </div>

        <!-- Métricas -->
        <div class="metrics-grid">
            <div class="metric-card primary">
                <div class="metric-header">
                    <div>
                        <div class="metric-title">Total OP</div>
                        <div class="metric-value" id="total-ops">0</div>
                        <div class="metric-subtitle">Órdenes de producción</div>
                    </div>
                    <div class="metric-icon primary">
                        <i class="bi bi-receipt"></i>
                    </div>
                </div>
            </div>

            <div class="metric-card success">
                <div class="metric-header">
                    <div>
                        <div class="metric-title">Total Distribuciones</div>
                        <div class="metric-value" id="total-distributions">0</div>
                        <div class="metric-subtitle">Productos distribuidos</div>
                    </div>
                    <div class="metric-icon success">
                        <i class="bi bi-box-seam"></i>
                    </div>
                </div>
            </div>

            <div class="metric-card info">
                <div class="metric-header">
                    <div>
                        <div class="metric-title">Clientes Activos</div>
                        <div class="metric-value" id="total-clients">0</div>
                        <div class="metric-subtitle">Con distribuciones</div>
                    </div>
                    <div class="metric-icon info">
                        <i class="bi bi-people"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla -->
        <div class="table-card">
            <div class="table-header">
                <h3 class="table-title">
                    <i class="bi bi-table"></i>
                    Registro de Distribuciones
                </h3>
            </div>
            <div class="table-container">
                <table id="distribution-table" class="display nowrap" style="width:100%">
                    <thead>
                        <tr>
                            <th></th>
                            <th>OP</th>
                            <th>Fecha</th>
                            <th>Planta</th>
                            <th>REF.PROV</th>
                            <th>Descripción</th>
                            <th>Referencia</th>
                            <th>Tipo</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="spinner"></div>
            <p class="loading-text">Cargando datos...</p>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@latest/dist/xlsx.full.min.js"></script>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>


      // Añadir esta función al inicio de tu script
function parseCustomDate(dateStr) {
    if (!dateStr) return null;
    
    // Intentar formato D/M/YYYY
    const parts = dateStr.split('/');
    if (parts.length === 3) {
        const day = parseInt(parts[0], 10);
        const month = parseInt(parts[1], 10) - 1; // meses 0-11
        const year = parseInt(parts[2], 10);
        
        // Validar valores
        if (day > 0 && day <= 31 && month >= 0 && month <= 11 && year > 1900) {
            return new Date(year, month, day);
        }
    }
    
    // Intentar parsear como ISO o lo que sea
    const date = new Date(dateStr);
    return isNaN(date.getTime()) ? null : date;
}



        // Configuración de Toast
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true,
            didOpen: (toast) => {
                toast.addEventListener('mouseenter', Swal.stopTimer)
                toast.addEventListener('mouseleave', Swal.resumeTimer)
            }
        });

        // Variables globales
        let allData = [];
        let filteredData = [];
        let dataTable;

        // Función para obtener datos reales de la API
        async function fetchRealData() {
            const apiKey = 'AIzaSyAn6o3jTwxe2ahhT-Aj03BWAS2ccE3NlE4';
            const fetchSheet = async (id, range) => {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${id}/values/${range}?key=${apiKey}`;
                const res = await fetch(url);
                if (!res.ok) throw new Error(`Error al obtener ${range}`);
                return (await res.json()).values || [];
            };
            const parseJSON = str => {
                try { return str ? JSON.parse(str) : null; } catch { return null; }
            };

            const [main, comp] = await Promise.all([
                fetchSheet('133NiyjNApZGkEFs4jUvpJ9So-cSEzRVeW2FblwOCrjI', 'DATA2!A2:S'),
                fetchSheet('1d5dCCCgiWXfM6vHu3zGGKlvK2EycJtT7Uk4JqUjDOfE', 'DATA!C2:C')
            ]);

            const compParsed = comp.map(r => parseJSON(r[0]));
            return main.map(row => {
                const doc = row[0]?.toString();
                const compMatch = compParsed.find(c => c?.Documento === doc);
                return {
                    A: row[0], FECHA: row[1], TALLER: row[2], LINEA: row[3],
                    AUDITOR: row[4], ESCANER: row[5], LOTE: row[6], REFPROV: row[7],
                    DESCRIPCIÓN: row[8], CANTIDAD: row[9], REFERENCIA: row[10],
                    TIPO: row[11], PVP: row[12], PRENDA: row[13], GENERO: row[14],
                    PROVEEDOR: row[15], ANEXOS: parseJSON(row[16]), HR: parseJSON(row[17]),
                    Clientes: compMatch ? compMatch.Clientes : null
                };
            });
        }

        // Función para calcular métricas
        function calculateMetrics(data) {
            const metrics = {
                totalOps: data.length,
                totalDistributions: 0,
                totalClients: new Set(),
                clientsDistribution: {}
            };

            data.forEach(row => {
                // Calcular distribuciones totales
                if (row.Clientes) {
                    for (const [cliente, datos] of Object.entries(row.Clientes)) {
                        metrics.totalClients.add(cliente);
                        
                        if (datos.distribucion && datos.distribucion.length > 0) {
                            const clienteTotal = datos.distribucion.reduce((sum, dist) => sum + (dist.cantidad || 0), 0);
                            metrics.totalDistributions += clienteTotal;
                            
                            // Acumular por cliente
                            if (!metrics.clientsDistribution[cliente]) {
                                metrics.clientsDistribution[cliente] = 0;
                            }
                            metrics.clientsDistribution[cliente] += clienteTotal;
                        }
                    }
                }
            });

            metrics.totalClients = metrics.totalClients.size;
            return metrics;
        }

        // Función para actualizar métricas en el UI
        function updateMetrics(data) {
            const metrics = calculateMetrics(data);
            
            document.getElementById('total-ops').textContent = metrics.totalOps.toLocaleString();
            document.getElementById('total-distributions').textContent = metrics.totalDistributions.toLocaleString();
            document.getElementById('total-clients').textContent = metrics.totalClients.toLocaleString();
        }

        // Función para llenar filtros
        function populateFilters(data) {
            const plants = [...new Set(data.map(item => item.TALLER).filter(Boolean))].sort();
            const types = [...new Set(data.map(item => item.TIPO).filter(Boolean))].sort();
            const providers = [...new Set(data.map(item => item.PROVEEDOR).filter(Boolean))].sort();

            const plantSelect = document.getElementById('filter-plant');
            const typeSelect = document.getElementById('filter-type');
            const providerSelect = document.getElementById('filter-provider');

            // Limpiar opciones existentes
            plantSelect.innerHTML = '<option value="">Todas las plantas</option>';
            typeSelect.innerHTML = '<option value="">Todos los tipos</option>';
            providerSelect.innerHTML = '<option value="">Todos los proveedores</option>';

            // Llenar plantas
            plants.forEach(plant => {
                const option = document.createElement('option');
                option.value = plant;
                option.textContent = plant;
                plantSelect.appendChild(option);
            });

            // Llenar tipos
            types.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                typeSelect.appendChild(option);
            });

            // Llenar proveedores
            providers.forEach(provider => {
                const option = document.createElement('option');
                option.value = provider;
                option.textContent = provider;
                providerSelect.appendChild(option);
            });
        }

        // Función para aplicar filtros
        function applyFilters() {
            const dateFrom = document.getElementById('date-from').value;
            const dateTo = document.getElementById('date-to').value;
            const plant = document.getElementById('filter-plant').value;
            const type = document.getElementById('filter-type').value;
            const provider = document.getElementById('filter-provider').value;

            filteredData = allData.filter(item => {
                // Filtro por fecha
// En la función applyFilters(), modificar el filtrado por fecha:
if (dateFrom || dateTo) {
    const itemParts = item.FECHA.split('/');
    let itemDate;
    
    if (itemParts.length === 3) {
        // Formato D/M/YYYY
        itemDate = new Date(itemParts[2], itemParts[1] - 1, itemParts[0]);
    } else {
        // Intentar parsear como está
        itemDate = new Date(item.FECHA);
    }
    
    if (isNaN(itemDate)) {
        console.warn('Fecha inválida:', item.FECHA);
        return false;
    }
    
    if (dateFrom) {
        const fromDate = new Date(dateFrom);
        if (itemDate < fromDate) return false;
    }
    
    if (dateTo) {
        const toDate = new Date(dateTo);
        toDate.setDate(toDate.getDate() + 1); // Incluir todo el día
        if (itemDate >= toDate) return false;
    }
}

                // Filtro por planta
                if (plant && item.TALLER !== plant) return false;

                // Filtro por tipo
                if (type && item.TIPO !== type) return false;

                // Filtro por proveedor
                if (provider && item.PROVEEDOR !== provider) return false;

                return true;
            });

            // Actualizar tabla y métricas
            updateDataTable(filteredData);
            updateMetrics(filteredData);

            Toast.fire({
                icon: 'success',
                title: `Filtros aplicados - ${filteredData.length} registros encontrados`
            });
        }

        // Función para limpiar filtros
        function clearFilters() {
            document.getElementById('date-from').value = '';
            document.getElementById('date-to').value = '';
            document.getElementById('filter-plant').value = '';
            document.getElementById('filter-type').value = '';
            document.getElementById('filter-provider').value = '';

            filteredData = allData;
            updateDataTable(filteredData);
            updateMetrics(filteredData);

            Toast.fire({
                icon: 'info',
                title: 'Filtros limpiados'
            });
        }

        // Función para inicializar DataTable
        function initializeDataTable(data) {
            if (dataTable) {
                dataTable.destroy();
            }
            
            dataTable = $('#distribution-table').DataTable({
                data: data,
                columns: [
                    {
                        className: 'dt-control',
                        orderable: false,
                        data: null,
                        defaultContent: '<i class="bi bi-chevron-right"></i>',
                        width: '20px'
                    },
                    { data: 'A', title: 'OP' },
// Reemplazar el render de fecha en las columnas de DataTables
{
    data: 'FECHA', 
    title: 'Fecha',
    render: function(data) {
        if (!data) return '';
        // Parsear fecha en formato D/M/YYYY
        const parts = data.split('/');
        if (parts.length === 3) {
            // Nota: los meses en JavaScript son 0-indexados (0-11)
            const date = new Date(parts[2], parts[1] - 1, parts[0]);
            return date.toLocaleDateString('es-ES');
        }
        // Si el formato no coincide, intentar parsear como está
        const date = new Date(data);
        return isNaN(date) ? data : date.toLocaleDateString('es-ES');
    }
},
                    { data: 'TALLER', title: 'Planta' },
                    { data: 'REFPROV', title: 'REF.PROV' },
                    { 
                        data: 'DESCRIPCIÓN', 
                        title: 'Descripción',
                        render: function(data) {
                            if (!data) return '';
                            return data.length > 50 ? data.substring(0, 50) + '...' : data;
                        }
                    },
                    { data: 'REFERENCIA', title: 'Referencia' },
                    { data: 'TIPO', title: 'Tipo' },
                    { 
                        data: null,
                        title: 'Total',
                        render: function(data, type, row) {
                            if (!row.Clientes) return '<span class="badge badge-warning">0</span>';
                            let total = 0;
                            for (const cliente in row.Clientes) {
                                if (row.Clientes[cliente].distribucion) {
                                    total += row.Clientes[cliente].distribucion.reduce((sum, dist) => sum + (dist.cantidad || 0), 0);
                                }
                            }
                            return `<span class="badge badge-${total > 0 ? 'success' : 'warning'}">${total.toLocaleString()}</span>`;
                        }
                    }
                ],
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json'
                },
                pageLength: 25,
                lengthMenu: [10, 25, 50, 100],
                order: [[2, 'desc']],
                responsive: true,
                dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' +
                     '<"row"<"col-sm-12"tr>>' +
                     '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>'
            });
            
            // Event listener para detalles de fila
            $('#distribution-table tbody').on('click', 'td.dt-control', function () {
                const tr = $(this).closest('tr');
                const row = dataTable.row(tr);
                const icon = $(this).find('i');
                
                if (row.child.isShown()) {
                    row.child.hide();
                    icon.removeClass('bi-chevron-down').addClass('bi-chevron-right');
                } else {
                    const rowData = row.data();
                    row.child(formatDetails(rowData)).show();
                    icon.removeClass('bi-chevron-right').addClass('bi-chevron-down');
                }
            });
        }

        // Función para actualizar DataTable
        function updateDataTable(data) {
            if (dataTable) {
                dataTable.clear().rows.add(data).draw();
            } else {
                initializeDataTable(data);
            }
        }

        // Función para formatear detalles de fila
        function formatDetails(rowData) {
            let totalDistribuciones = 0;
            if (rowData.Clientes) {
                for (const cliente in rowData.Clientes) {
                    if (rowData.Clientes[cliente].distribucion) {
                        totalDistribuciones += rowData.Clientes[cliente].distribucion.reduce((sum, dist) => sum + (dist.cantidad || 0), 0);
                    }
                }
            }
            
            let details = `
                <div class="detail-content">
                    <div class="detail-section">
                        <h5><i class="bi bi-info-circle"></i> Información General</h5>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <div class="detail-label">Auditor</div>
                                <div class="detail-value">${rowData.AUDITOR || 'N/A'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Escáner</div>
                                <div class="detail-value">${rowData.ESCANER || 'N/A'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Lote</div>
                                <div class="detail-value">${rowData.LOTE || 'N/A'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">PVP</div>
                                <div class="detail-value">${rowData.PVP || 'N/A'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Prenda</div>
                                <div class="detail-value">${rowData.PRENDA || 'N/A'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Género</div>
                                <div class="detail-value">${rowData.GENERO || 'N/A'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Cantidad Total</div>
                                <div class="detail-value">${rowData.CANTIDAD || 'N/A'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Total Distribuciones</div>
                                <div class="detail-value"><span class="badge badge-success">${totalDistribuciones}</span></div>
                            </div>
                        </div>
                    </div>`;
            
            // Anexos
            if (rowData.ANEXOS && rowData.ANEXOS.length > 0) {
                details += `
                    <div class="detail-section">
                        <h5><i class="bi bi-paperclip"></i> Anexos (${rowData.ANEXOS.length})</h5>
                        <table class="sub-table">
                            <thead>
                                <tr>
                                    <th>Documento</th>
                                    <th>Talla</th>
                                    <th>Color</th>
                                    <th>Tipo</th>
                                    <th>Cantidad</th>
                                    <th>Acción</th>
                                </tr>
                            </thead>
                            <tbody>`;
                
                rowData.ANEXOS.forEach(anexo => {
                    details += `
                        <tr>
                            <td>${anexo.DOCUMENTO || ''}</td>
                            <td>${anexo.TALLA || ''}</td>
                            <td>${anexo.COLOR || ''}</td>
                            <td>${anexo.TIPO || ''}</td>
                            <td><span class="badge badge-info">${anexo.CANTIDAD || ''}</span></td>
                            <td>${anexo.ACCION || 'N/A'}</td>
                        </tr>`;
                });
                
                details += `
                            </tbody>
                        </table>
                    </div>`;
            }
            
            // HR
            if (rowData.HR && rowData.HR.length > 0) {
                details += `
                    <div class="detail-section">
                        <h5><i class="bi bi-gear"></i> HR (${rowData.HR.length})</h5>
                        <table class="sub-table">
                            <thead>
                                <tr>
                                    <th>Código</th>
                                    <th>Color</th>
                                    <th>Talla</th>
                                    <th>Cantidad</th>
                                </tr>
                            </thead>
                            <tbody>`;
                
                rowData.HR.forEach(hr => {
                    details += `
                        <tr>
                            <td>${hr[0] || ''}</td>
                            <td>${hr[1] || ''}</td>
                            <td>${hr[2] || ''}</td>
                            <td><span class="badge badge-primary">${hr[3] || ''}</span></td>
                        </tr>`;
                });
                
                details += `
                            </tbody>
                        </table>
                    </div>`;
            }
            
            // Clientes y distribuciones
            if (rowData.Clientes && Object.keys(rowData.Clientes).length > 0) {
                details += `
                    <div class="detail-section">
                        <h5><i class="bi bi-people"></i> Distribuciones por Cliente</h5>`;
                
                for (const [cliente, datos] of Object.entries(rowData.Clientes)) {
                    const clienteTotal = datos.distribucion ? 
                        datos.distribucion.reduce((sum, dist) => sum + (dist.cantidad || 0), 0) : 0;
                    
                    details += `
                        <div class="client-section">
                            <div class="client-header">
                                <div class="client-name">${cliente}</div>
                                <div class="client-badges">
                                    ${datos.id ? `<span class="badge badge-primary">ID: ${datos.id}</span>` : ''}
                                    ${datos.porcentaje ? `<span class="badge badge-success">${datos.porcentaje}</span>` : ''}
                                    <span class="badge badge-info">Total: ${clienteTotal}</span>
                                </div>
                            </div>`;
                    
                    if (datos.distribucion && datos.distribucion.length > 0) {
                        details += `
                            <table class="sub-table">
                                <thead>
                                    <tr>
                                        <th>Código</th>
                                        <th>Color</th>
                                        <th>Talla</th>
                                        <th>Cantidad</th>
                                    </tr>
                                </thead>
                                <tbody>`;
                        
                        datos.distribucion.forEach(dist => {
                            details += `
                                <tr>
                                    <td>${dist.codigo || ''}</td>
                                    <td>${dist.color || ''}</td>
                                    <td>${dist.talla || ''}</td>
                                    <td><span class="badge badge-success">${(dist.cantidad || 0).toLocaleString()}</span></td>
                                </tr>`;
                        });
                        
                        details += `
                                </tbody>
                            </table>`;
                    } else {
                        details += `<p style="color: var(--color-gray-500); font-style: italic; text-align: center; padding: 20px;">No hay distribuciones registradas</p>`;
                    }
                    
                    details += `</div>`;
                }
                
                details += `</div>`;
            } else {
                details += `
                    <div class="detail-section">
                        <p style="color: var(--color-gray-500); font-style: italic; text-align: center; padding: 40px;">
                            <i class="bi bi-info-circle" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                            No hay datos de clientes registrados
                        </p>
                    </div>`;
            }
            
            details += `</div>`;
            return details;
        }

        // Función para cargar datos
        function loadData() {
            $('#loading-overlay').show();
            $('#refresh-btn').prop('disabled', true);
            $('#refresh-btn').html('<div class="spinner" style="width: 16px; height: 16px; margin-right: 8px;"></div> Actualizando');
            
            fetchRealData().then(function(data) {
                allData = data;
                filteredData = data;
                
                populateFilters(data);
                initializeDataTable(data);
                updateMetrics(data);
                
                $('#export-excel').prop('disabled', false);
                Toast.fire({ 
                    icon: 'success', 
                    title: `${data.length} registros cargados correctamente` 
                });
            }).catch(function(error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error al cargar datos',
                    text: error.message || 'No se pudo conectar con el servidor',
                    confirmButtonColor: 'var(--color-primary)'
                });
                console.error(error);
            }).finally(function() {
                $('#refresh-btn').prop('disabled', false);
                $('#refresh-btn').html('<i class="bi bi-arrow-repeat"></i> Actualizar');
                $('#loading-overlay').hide();
                updateLastUpdateDate();
            });
        }

        // Función para actualizar fecha de última actualización
        function updateLastUpdateDate() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('es-ES', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            $('#last-update').text(dateStr);
        }

        // Función para exportar a Excel
        // Función mejorada para exportar a Excel
function exportToExcel() {
    const loadingToast = Toast.fire({
        icon: 'info',
        title: 'Preparando archivo Excel...',
        didOpen: () => {
            Swal.showLoading();
        }
    });

    setTimeout(() => {
        try {
            const dataToExport = filteredData.length > 0 ? filteredData : allData;
            
            if (!dataToExport || dataToExport.length === 0) {
                loadingToast.close();
                Swal.fire({
                    icon: 'warning',
                    title: 'No hay datos',
                    text: 'No hay datos disponibles para exportar',
                    confirmButtonColor: 'var(--color-primary)'
                });
                return;
            }

            // Preparar datos con el formato de fecha correcto
            const exportData = dataToExport.map(row => {
                let totalDistribuciones = 0;
                let clientesInfo = [];
                
                if (row.Clientes) {
                    for (const cliente in row.Clientes) {
                        if (row.Clientes[cliente].distribucion) {
                            const clienteTotal = row.Clientes[cliente].distribucion.reduce((sum, dist) => sum + (dist.cantidad || 0), 0);
                            totalDistribuciones += clienteTotal;
                            clientesInfo.push(`${cliente}: ${clienteTotal}`);
                        }
                    }
                }

                // Formatear la fecha correctamente para Excel
                let formattedDate = '';
                if (row.FECHA) {
                    const date = parseCustomDate(row.FECHA);
                    if (date && !isNaN(date)) {
                        // Formato DD/MM/YYYY para Excel
                        const day = date.getDate().toString().padStart(2, '0');
                        const month = (date.getMonth() + 1).toString().padStart(2, '0');
                        const year = date.getFullYear();
                        formattedDate = `${day}/${month}/${year}`;
                    } else {
                        formattedDate = row.FECHA; // Mantener el valor original si no se puede parsear
                    }
                }

                return {
                    'OP': row.A || '',
                    'Fecha': formattedDate,
                    'Planta': row.TALLER || '',
                    'REF.PROV': row.REFPROV || '',
                    'Descripción': (row.DESCRIPCIÓN || '').substring(0, 100),
                    'Referencia': row.REFERENCIA || '',
                    'Tipo': row.TIPO || '',
                    'Cantidad Total': row.CANTIDAD || 0,
                    'Total Distribuciones': totalDistribuciones,
                    'Clientes': clientesInfo.join(' | ') || 'N/A',
                    'Proveedor': row.PROVEEDOR || ''
                };
            });

            // Crear hoja de cálculo
            const worksheet = XLSX.utils.json_to_sheet(exportData);
            
            // Ajustar anchos de columnas
            const wscols = [
                {wch: 10}, // OP
                {wch: 12}, // Fecha
                {wch: 15}, // Planta
                {wch: 15}, // REF.PROV
                {wch: 30}, // Descripción
                {wch: 15}, // Referencia
                {wch: 15}, // Tipo
                {wch: 12}, // Cantidad Total
                {wch: 12}, // Total Distribuciones
                {wch: 40}, // Clientes
                {wch: 20}  // Proveedor
            ];
            worksheet['!cols'] = wscols;

            // Crear libro de trabajo
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Distribuciones");

            // Generar nombre de archivo con fecha
            const now = new Date();
            const dateStr = now.toISOString().slice(0, 10).replace(/-/g, '');
            const timeStr = now.toTimeString().slice(0, 8).replace(/:/g, '');
            const filename = `Distribuciones_${dateStr}_${timeStr}.xlsx`;

            try {
                const excelBuffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
                const blob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                saveAs(blob, filename);
                
                loadingToast.close();
                Toast.fire({
                    icon: 'success',
                    title: `Archivo "${filename}" descargado`,
                    text: `${exportData.length} registros exportados`
                });
            } catch (e) {
                console.error("Error con FileSaver:", e);
                try {
                    XLSX.writeFile(workbook, filename);
                    loadingToast.close();
                    Toast.fire({
                        icon: 'success',
                        title: `Archivo "${filename}" descargado`,
                        text: `${exportData.length} registros exportados`
                    });
                } catch (e2) {
                    console.error("Error con writeFile:", e2);
                    loadingToast.close();
                    Swal.fire({
                        icon: 'error',
                        title: 'Error al descargar',
                        html: `No se pudo generar el archivo. <br><br>
                               <small>Detalles: ${e.message || 'Error desconocido'}</small>`,
                        confirmButtonColor: 'var(--color-primary)'
                    });
                }
            }
        } catch (error) {
            console.error("Error en exportToExcel:", error);
            loadingToast.close();
            Swal.fire({
                icon: 'error',
                title: 'Error al exportar',
                html: `Ocurrió un error al generar el archivo Excel. <br><br>
                       <small>${error.message || 'Error desconocido'}</small>`,
                confirmButtonColor: 'var(--color-primary)'
            });
        }
    }, 100);
}


        // Inicialización cuando el documento está listo
        $(document).ready(function() {
            // Event listeners
            $('#refresh-btn').click(loadData);
            $('#export-excel').click(exportToExcel);
            $('#apply-filters').click(applyFilters);
            $('#clear-filters').click(clearFilters);
            
            // Event listeners para filtros automáticos
            $('#date-from, #date-to').change(function() {
                if ($('#date-from').val() || $('#date-to').val()) {
                    applyFilters();
                }
            });

            // Cargar datos iniciales
            loadData();
        });
    </script>
</body>
</html>
